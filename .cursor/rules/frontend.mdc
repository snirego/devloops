---
description: Rules for the Next.js web application — pages, views, components, hooks
globs: apps/web/**
alwaysApply: false
---

# Frontend (`@kan/web`)

## Package Overview

`apps/web/` is the Next.js 15 application using the **Pages Router**, React 18, Tailwind CSS, and tRPC for data fetching.

## Directory Structure

```
apps/web/src/
  pages/            → Next.js file-based routes (Pages Router)
    api/            → API routes (tRPC, auth, uploads, Stripe webhooks, OpenAPI v1)
    boards/         → Board pages
    cards/          → Card detail pages
    settings/       → Settings pages
    login/          → Login page
    signup/         → Signup page
    [workspaceSlug] → Dynamic workspace route
  views/            → Page-level view components (heavy lifting)
    board/          → Board view + components/
    boards/         → Boards list view + components/
    card/           → Card detail view + components/
    auth/           → Login / signup views
    settings/       → Settings views + components/
    …
  components/       → Shared/reusable UI components
  hooks/            → Custom React hooks
  providers/        → React context providers
  utils/            → Client-side utility functions
  styles/           → Global CSS / Tailwind
  types/            → Shared TypeScript types
  locales/          → Lingui translation files (en, de, es, fr, it, nl, pl, pt-BR, ru)
  assets/           → Static assets (logos, etc.)
```

## Page / View Pattern

Pages are thin wrappers that compose layout + view:

```tsx
// pages/boards/[...boardId]/index.tsx
import type { NextPageWithLayout } from "~/pages/_app";
import { getDashboardLayout } from "~/components/Dashboard";
import BoardView from "~/views/board";

const BoardPage: NextPageWithLayout = () => (
  <>
    <BoardView />
    <Popup />
  </>
);

BoardPage.getLayout = (page) => getDashboardLayout(page);
export default BoardPage;
```

- **Pages**: Minimal — just mount a view component and assign a layout.
- **Views**: Contain all the page logic, data fetching, and sub-components. Views live in `src/views/<feature>/` and can have a `components/` subfolder for local components.
- **Layouts**: Use `getLayout` pattern for persistent layouts (e.g. dashboard sidebar).

## Component Rules

- Place **shared / reusable** components in `src/components/`.
- Place **feature-specific** components in `src/views/<feature>/components/`.
- Use `PascalCase` for component file names (e.g. `Button.tsx`, `CardModal.tsx`).
- Prefer function components with TypeScript interfaces for props.
- Export components as named exports (not default) for shared components; default export is fine for view-level components.

## Styling

- **Tailwind CSS** for all styling — no CSS modules or styled-components.
- Use `tailwind-merge` (`twMerge`) when conditionally combining class names.
- Follow the shared Tailwind config from `@kan/tailwind-config`.

### Dark Mode Color Guidelines

The project uses a custom neutral color scale (`dark-50` through `dark-1000`). In dark mode, avoid using low-end values for text — they are nearly invisible against dark backgrounds.

| Purpose | Light mode | Dark mode |
|---|---|---|
| Primary text | `text-light-1000` | `text-dark-1000` |
| Strong secondary text (labels, prominent descriptions) | `text-light-800` | `text-dark-950` |
| Secondary text (descriptions, helper text) | `text-light-700` | `text-dark-900` |
| Tertiary text (metadata, captions, subtle info) | `text-light-600` | `text-dark-800` |
| Muted icons (chevrons, action icons) | `text-light-500` | `text-dark-800` |
| Input borders / rings | `ring-light-600` | `ring-dark-500` (focus: `ring-dark-600`) |
| Input placeholders | `placeholder:text-light-700` | `dark:placeholder:text-dark-700` |

**Never** use `dark:text-dark-500` or `dark:text-dark-600` for text — these are too dim and make the UI look disabled. The minimum for readable text in dark mode is `dark-700` for placeholders and `dark-800` for visible content.

### Loading & Animation Patterns

- Use the `animate-shimmer` utility for loading text effects. The shimmer sweeps left-to-right (LTR, matching English reading direction).
- Shimmer text uses **white/neutral** tones, not brand colors. Apply via `bg-clip-text text-transparent` with a gradient:
  - Light: `from-light-700 via-light-1000 to-light-700`
  - Dark: `dark:from-dark-800 dark:via-dark-1000 dark:to-dark-800`
- For inline loading spinners, keep them **small and thin** (`h-3.5 w-3.5`, `strokeWidth="2"`) in neutral colors, placed on the same row as the loading text.
- Prefer minimal, elegant loading states over heavy progress bars or large spinners.
- Available animations: `animate-shimmer`, `animate-fade-in`, `animate-fade-down`, `animate-spin`, `animate-pulse-slow`.

## Data Fetching (tRPC) — Local-First

> Full details in the `local-first.mdc` rules file. Key points below.

- Use tRPC React Query hooks for all server state:
  - `api.<router>.<procedure>.useQuery()` for reads.
  - `api.<router>.<procedure>.useMutation()` for writes.
- **Always set `staleTime`** appropriate to the data type (see local-first.mdc for the table).
- **Never block rendering** on `isLoading` when cached `data` exists — use `if (isLoading && !data)`.
- Implement **optimistic updates** via `onMutate` for all user-visible mutations.
- Invalidate relevant queries in `onSettled` (not `onSuccess` — `onSettled` fires on both success and error).
- Use **Supabase Realtime** subscriptions instead of `refetchInterval` for live data.
- Never call `fetch()` directly for tRPC endpoints — always use the typed hooks.

## Internationalization (Lingui)

- All user-facing strings must use the `t` template literal from `@lingui/macro`:
  ```tsx
  import { t } from "@lingui/macro";
  const label = t`Create new board`;
  ```
- After adding new strings, run `pnpm lingui:extract` from `apps/web/`.
- Translation files are in `src/locales/<lang>/messages.po`.
- Lingui uses an SWC plugin for compilation (configured in `next.config.js`).

## State Management

| Type | Approach |
|---|---|
| Server state | tRPC + React Query (cache-first, background revalidation) |
| Realtime sync | Supabase Realtime subscriptions (replaces polling) |
| Optimistic mutations | `onMutate` / `onError` / `onSettled` pattern |
| App shell hydration | localStorage cache for workspace, user profile |
| UI modals | `useModal()` hook |
| Toast / popups | `usePopup()` hook |
| Theme | `next-themes` |
| Auth session | `authClient.useSession()` from `@kan/auth/client` |

## Hooks

Custom hooks live in `src/hooks/`. Follow the `use<Name>` convention. Common hooks:

- `useModal()` — modal state management
- `usePopup()` — toast notification management
- Auth hooks from `@kan/auth`

## API Routes

- tRPC handler: `src/pages/api/trpc/[trpc].ts`
- Auth routes: `src/pages/api/auth/[...all].ts` + specific handlers
- OpenAPI (REST): `src/pages/api/v1/[...trpc].ts`
- File uploads: `src/pages/api/upload/`
- Stripe webhooks: `src/pages/api/stripe/`

## Images & Assets

- Use Next.js `<Image>` component for optimized images.
- Remote image patterns are configured in `next.config.js`.
- SVGs are loaded via `@svgr/webpack` (configured in turbopack rules).

## Performance

- `optimizePackageImports` is configured for `react-icons`, `date-fns`, `@headlessui/react`, `framer-motion`.
- Use dynamic imports (`next/dynamic`) for heavy components that aren't needed on first paint.
- Implement proper loading and error states for all data-fetching components.
- **Never show a full-page spinner when cached/stale data is available.** Show stale data immediately and sync in the background.
- Use granular loading indicators (`isFetching`, `isProcessingAI`, `isUpdatingWorkItem`) rather than a single global loading state.
- See `local-first.mdc` for the complete performance safety checklist.

## Path Aliases

- `~/` maps to `src/` (configured in `tsconfig.json`).
- Example: `import Button from "~/components/Button"`.
